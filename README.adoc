= UniversalJSON

* This is a check plugin for checkmk with a ruleset.
* It aims to be a "better" *local* check.

Download mkp 

https://github.com/grepmeister/universaljson/raw/refs/heads/main/assets/universaljson-1.0.1.mkp

== Advantages over local check

* Agent section data is structured JSON.
* The agent can decide if the state is OK, WARNING, CRITICAL, or UNKNOWN just like with local checks ...
* But you can configure service rules to override the state if threshold values are exceeded or too low.
* In other words: If you have metrics, you can configure thresholds on the checkmk serverüéâ.
* Unlike local checks it supports counters üçª !!!
* You can emit your own details and summary.

== How does this work?

=== Example: One service with details summary in OK state

.Simple example
[source]
----
<<<universaljson:sep(0)>>>
{"services":{"service0":{"summary":"summary for service0","details":"details for service0, expected to be OK","state":0}}}
----

TIP: As common with checkmk, the JSON is expected to be on one line in the agent output.

.Human readable
[source,json,linenums]
----
{
  "services": {
    "service0": {
      "summary": "summary for service0",
      "details": "details for service0, expected to be OK",
      "state": 0
    }
  }
}
----

[TIP]
====
Here it's just pretty printed to make it easier to understand the structure of the JSON.
You can format your JSON to a single line with:
[source, bash]
----
jq -c < file.json
jq --compact-output < file.json
----
====

=== Example: more complex JSON

.More complex JSON example
[source]
----
<<<universaljson:sep(0)>>>
{"services":{"service0":{"summary":"summary for service0","details":"details for service0, expected to be OK","state":0},"service1":{"summary":"summary for service1","details":"details for service1, expected to be WARN","state":1},"service2":{"summary":"summary for service2","details":"details for service2, expected to be CRIT","state":2},"service3":{"summary":"summary for service3","details":"details for service3, expected to be UNK","state":3},"service4":{"state":0,"summary":"summary for service4","details":"details for service4","metrics":{"temp":46,"humidity":70}},"service5":{"summary":"summary for service5","details":"details for service5, it's a counter","metrics":{"mycounter":"1754224044c"}}}}
----

.Human readable
[source,json,linenums]
----
{
  "services": {
    "service0": {
      "summary": "summary for service0",
      "details": "details for service0, expected to be OK",
      "state": 0 
    },
    "service1": {
      "summary": "summary for service1",
      "details": "details for service1, expected to be WARN",
      "state": 1 
    },
    "service2": {
      "summary": "summary for service2",
      "details": "details for service2, expected to be CRIT",
      "state": 2
    },
    "service3": {
      "summary": "summary for service3",
      "details": "details for service3, expected to be UNK",
      "state": 3 
    },
    "service4": {
      "state": 0, 
      "summary": "summary for service4",
      "details": "details for service4",
      "metrics": {
        "temp": 46.0,
        "humidity": 70.0 
      }
    },
    "service5": {
      "summary": "summary for service5",
      "details": "details for service5, it's a counter",
      "metrics": {
        "mycounter": "1754143835c"
      }
    }
  }
}
----

.Explanation

* `service4` generates two float metrics *temp* and *humidity*.
* `service5` generates a metric which is actually a *counter* because it's a JSON string and not a float (using "quotes") and has a suffix of `c`, like it was common in nagios compatible checks.

image::assets/services.png[]

== Ruleset

image::assets/full_ruleset.png[]

Full page, annotated...

image::assets/full_ruleset_annotated.png[]

== Demo agent output for testing

* link:assets/universaljson.txt[universaljson.txt]
* e.g. put it in the https://docs.checkmk.com/latest/en/spool_directory.html[spool directory], usually `/var/lib/check_mk_agent/spool/`

== Demo agent plugin config-generations-per-second.py

* One service per site with one metric to show the Config generations per second.
* https://raw.githubusercontent.com/grepmeister/universaljson/refs/heads/main/assets/usr/lib/check_mk_agent/plugins/config-generations-per-second.py[]

== TODO

* introduce a timestamp field to the JSON data and allow to warn if JSON data is outdated
* smooth the metric measurements with a "truncated mean" a.k.a. "trimmed mean"" (from the recent 5 past measurements drop the highest and the lowest and average the remaining 3) to avoid false alerts.
* add type hints to Python code
* An "universal http(s) agent data fetcher" is in the pipe and will play well together with this check

